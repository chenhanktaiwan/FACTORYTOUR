<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åƒè§€å·¥å» é ç´„</title>
  <style>
    /* Cloudflare ç‰ˆæ¨£å¼ï¼šä¿æŒ LINE é¢¨æ ¼ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f2f2f2; padding: 20px; margin: 0; }
    .container { background-color: white; border-radius: 10px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
    h2 { color: #06C755; text-align: center; margin-bottom: 25px; font-weight: bold; }
    label { display: block; margin-top: 15px; font-weight: bold; color: #333; font-size: 14px; }
    input, select { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fafafa; }
    button { width: 100%; background-color: #06C755; color: white; border: none; padding: 15px; font-size: 16px; border-radius: 8px; margin-top: 30px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
    button:active { background-color: #05a546; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .hidden { display: none; }
    .loading { text-align: center; color: #666; font-size: 14px; margin-top: 10px; display: none; }
  </style>
</head>
<body>

  <div class="container" id="formPage">
    <h2>ğŸ­ åƒè§€å·¥å» é ç´„</h2>
    
    <form id="bookingForm">
      <label>æ‚¨çš„å§“å</label>
      <input type="text" name="name" required placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å">
      
      <label>è¯çµ¡é›»è©±</label>
      <input type="tel" name="phone" required placeholder="09xxxxxxxx">
      
      <label>é¸æ“‡å ´æ¬¡</label>
      <select id="sessionSelect" name="session" required onchange="checkQuota()">
        <option value="" disabled selected>é€£ç·šè®€å–ä¸­...</option>
      </select>
      
      <label>å ±åäººæ•¸ (å«æœ¬äºº)</label>
      <select name="count" id="countSelect" required>
        <option value="1">1 äºº</option>
      </select>
      
      <button type="button" onclick="submitForm()" id="submitBtn">ç«‹å³é ç´„</button>
      <div class="loading" id="loadingMsg">è³‡æ–™å‚³è¼¸ä¸­ï¼Œè«‹ç¨å€™...</div>
    </form>
  </div>

  <div class="container hidden" id="successPage" style="text-align: center; padding: 50px 20px;">
    <div style="font-size: 50px;">âœ…</div>
    <h2 style="color: #333; margin-top: 20px;">é ç´„æˆåŠŸï¼</h2>
    <p style="color: #666; line-height: 1.6;">æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è³‡æ–™ã€‚<br>è«‹ç•™æ„æ‰‹æ©Ÿç°¡è¨Šæˆ–è¡Œå‰é€šçŸ¥ã€‚</p>
    <button onclick="window.location.reload()" style="background-color: #eee; color: #333; margin-top: 20px;">è¿”å›é¦–é </button>
  </div>

  <script>
    // âš ï¸ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€
    var API_URL = "https://script.google.com/macros/s/AKfycbxCLHDwS2_urNt5dQgWXYQAuc2J-9R0wjSH8E994o-LaPZiNqkiAvl5XUEnZSPdGOx60Q/exec"; 

    // 1. åˆå§‹åŒ–ï¼šè®€å–å ´æ¬¡
    window.onload = function() {
      // å‘¼å« GAS çš„ doGet
      fetch(API_URL + "?op=get_sessions")
        .then(res => res.json())
        .then(sessions => {
            sessionData = sessions;
            renderSessions(sessions);
        })
        .catch(err => {
            alert("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ GAS ç¶²å€è¨­å®š");
            console.error(err);
        });
    };

    var sessionData = [];

    function renderSessions(sessions) {
      var select = document.getElementById("sessionSelect");
      select.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å ´æ¬¡</option>';
      
      sessions.forEach(function(s) {
        var text = s.name + " (å‰©é¤˜ " + s.left + " åé¡)";
        if (s.left <= 0) text = s.name + " (å·²é¡æ»¿)";
        
        var option = document.createElement("option");
        option.text = text;
        option.value = s.name;
        if(s.left <= 0) option.disabled = true;
        select.add(option);
      });
    }

    function checkQuota() {
        var selectedName = document.getElementById("sessionSelect").value;
        var selectedSession = sessionData.find(s => s.name === selectedName);
        if (selectedSession) {
            var countSelect = document.getElementById("countSelect");
            countSelect.innerHTML = "";
            var max = Math.min(4, selectedSession.left); 
            for(var i=1; i<=max; i++) {
                var opt = document.createElement("option");
                opt.value = i;
                opt.text = i + " äºº";
                countSelect.add(opt);
            }
        }
    }

    function submitForm() {
      var btn = document.getElementById("submitBtn");
      var loading = document.getElementById("loadingMsg");
      var form = document.getElementById("bookingForm");
      
      if (!form.checkValidity()) {
        alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
        return;
      }

      // æº–å‚™è³‡æ–™
      var formData = new FormData(form);

      // UI é–å®š
      btn.disabled = true;
      btn.innerText = "é ç´„ä¸­...";
      loading.style.display = "block";

      // 2. é€å‡ºè³‡æ–™ï¼šä½¿ç”¨ POST
      fetch(API_URL, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        if (result.status === "success") {
            document.getElementById("formPage").classList.add("hidden");
            document.getElementById("successPage").classList.remove("hidden");
        } else if (result.status === "full") {
            alert("å“å‘€ï¼æ…¢äº†ä¸€æ­¥ï¼Œè©²å ´æ¬¡å‰›å‰›é¡æ»¿äº†ï¼");
            window.location.reload();
        } else {
            alert("ç³»çµ±éŒ¯èª¤ï¼š" + result.msg);
            resetBtn();
        }
      })
      .catch(err => {
        // GAS è·¨åŸŸ redirect å¸¸è¦‹ç¾è±¡ï¼Œå¦‚æœå›å‚³æˆåŠŸé€šå¸¸æ˜¯200ï¼Œä½†æœ‰æ™‚æœƒæœ‰ CORS è­¦å‘Š
        // é€™è£¡åšä¸€å€‹ç°¡å–®è™•ç†ï¼Œå‡è¨­æ²’å™´éŒ¯å°±æ˜¯é€šçš„
        console.error(err);
        alert("é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦");
        resetBtn();
      });
    }

    function resetBtn() {
        var btn = document.getElementById("submitBtn");
        var loading = document.getElementById("loadingMsg");
        btn.disabled = false;
        btn.innerText = "ç«‹å³é ç´„";
        loading.style.display = "none";
    }
  </script>
</body>
</html>
